# Claude 4 提示工程最佳实践

本指南提供了针对 Claude 4 模型（Opus 4.1、Opus 4、Sonnet 4.5 和 Sonnet 4）的特定提示工程技术，以帮助您在应用程序中获得最佳结果。与前几代 Claude 模型相比，这些模型经过训练，能够更精确地遵循指令。

<Info>
  有关 Claude Sonnet 4.5 新功能的概述，请参阅[Claude Sonnet 4.5 的新功能](/en/docs/about-claude/models/whats-new-sonnet-4-5)。有关从先前模型迁移的指导，请参阅[迁移到 Claude 4](/en/docs/about-claude/models/migrating-to-claude-4)。
</Info>

##通用原则

### 明确您的指示

Claude 4 模型对清晰、明确的指示反应良好。具体说明您期望的输出有助于增强结果。希望从以前的 Claude 模型中获得“超越”行为的客户可能需要更明确地向 Claude 4 请求这些行为。

#### 示例：创建分析仪表板

**效果较差：**

  ```text
  创建一个分析仪表板
  ```

**效果更佳：**

  ```text
  创建一个分析仪表板。包括尽可能多的相关功能和交互。超越基础，创建一个功能齐全的实现。
  ```
### 添加上下文以提高性能

在您的指示背后提供上下文或动机，例如向 Claude 解释为什么这种行为很重要，可以帮助 Claude 4 模型更好地理解您的目标并提供更有针对性的响应。

#### 示例：格式偏好
 **效果较差：**

  ```text
  永远不要使用省略号
  ```

 **效果更佳：**

  ```text
  您的响应将由文本转语音引擎朗读，因此切勿使用省略号，因为文本转语音引擎不知道如何发音。
  ```
Claude 足够聪明，可以从解释中进行概括。

### 对示例和细节保持警惕

Claude 4 模型密切关注细节和示例，这是其精确遵循指令能力的一部分。确保您的示例与您希望鼓励的行为保持一致，并尽量减少您希望避免的行为。

### 长期推理和状态跟踪

Claude Sonnet 4.5 在具有出色状态跟踪能力的长期推理任务中表现出色。它通过专注于增量进展——一次在几件事上稳步前进，而不是一次尝试所有事情——在扩展会话中保持方向。这种能力在多个上下文窗口或任务迭代中尤其突出，Claude 可以在其中处理复杂任务、保存状态并使用新的上下文窗口继续。

#### 上下文感知和多窗口工作流

Claude Sonnet 4.5 具有[上下文感知](/en/docs/build-with-claude/context-windows#context-awareness-in-claude-sonnet-4-5)功能，使模型能够在整个对话过程中跟踪其剩余的上下文窗口（即“令牌预算”）。这使得 Claude 能够通过了解自己有多少工作空间来更有效地执行任务和管理上下文。

**管理上下文限制：**

如果您在代理工具中使用 Claude，该工具会压缩上下文或允许将上下文保存到外部文件（如在 Claude Code 中），我们建议将此信息添加到您的提示中，以便 Claude 可以相应地行动。否则，Claude 有时可能会在接近上下文限制时自然地尝试结束工作。以下是一个示例提示：

```text 示例提示
当您的上下文窗口接近其限制时，它将自动被压缩，让您从中断的地方无限期地继续工作。因此，不要因为令牌预算问题而提前停止任务。当您接近令牌预算限制时，在上下文窗口刷新之前将您当前的进度和状态保存到内存中。始终尽可能地持久和自主，并完全完成任务，即使您的预算即将结束。无论剩余上下文如何，切勿人为地提前停止任何任务。
```

[内存工具](/en/docs/agents-and-tools/tool-use/memory-tool)与上下文感知功能自然结合，可实现无缝的上下文转换。

#### 多上下文窗口工作流

对于跨越多个上下文窗口的任务：

1.  **为第一个上下文窗口使用不同的提示**：使用第一个上下文窗口来设置框架（编写测试、创建设置脚本），然后使用未来的上下文窗口来迭代待办事项列表。

2.  **让模型以结构化格式编写测试**：要求 Claude 在开始工作前创建测试，并以结构化格式（例如，`tests.json`）跟踪它们。这有助于提高长期迭代的能力。提醒 Claude 测试的重要性：“删除或编辑测试是不可接受的，因为这可能导致功能缺失或错误。”

3.  **设置生活质量工具**：鼓励 Claude 创建设置脚本（例如，`init.sh`）以优雅地启动服务器、运行测试套件和 linter。这可以防止在从新的上下文窗口继续时重复工作。

4.  **重新开始与压缩**：当上下文窗口被清除时，考虑从一个全新的上下文窗口开始，而不是使用压缩。Sonnet 4.5 在从本地文件系统发现状态方面非常有效。在某些情况下，您可能希望利用这一点而不是压缩。对其应如何开始进行规定：
    *   “调用 pwd；您只能在此目录中读写文件。”
    *   “查看 progress.txt、tests.json 和 git 日志。”
    *   “在继续实现新功能之前，手动运行一个基本集成测试。”

5.  **提供验证工具**：随着自主任务长度的增加，Claude 需要在没有持续的人工反馈的情况下验证正确性。像 Playwright MCP 服务器或用于测试 UI 的计算机使用功能等工具会很有帮助。

6.  **鼓励充分利用上下文**：提示 Claude 在继续之前有效地完成组件：

```text 示例提示
这是一项非常长的任务，因此清晰地规划您的工作可能会有所裨益。鼓励您将整个输出上下文用于处理任务——只需确保您不会在有大量未提交工作的情况下用完上下文。系统地继续工作，直到您完成此任务。
```

#### 状态管理最佳实践

*   **对状态数据使用结构化格式**：在跟踪结构化信息（如测试结果或任务状态）时，使用 JSON 或其他结构化格式来帮助 Claude 理解模式要求
*   **对进度说明使用非结构化文本**：自由格式的进度说明非常适合跟踪总体进度和上下文
*   **使用 git 进行状态跟踪**：Git 提供了已完成工作的日志和可以恢复的检查点。Claude Sonnet 4.5 在使用 git 跨多个会话跟踪状态方面表现尤其出色。
*   **强调增量进展**：明确要求 Claude 跟踪其进展并专注于增量工作

<Accordion title="示例：状态跟踪">
  ```json
  // 结构化状态文件 (tests.json)
  {
    "tests": [
      {"id": 1, "name": "authentication_flow", "status": "passing"},
      {"id": 2, "name": "user_management", "status": "failing"},
      {"id": 3, "name": "api_endpoints", "status": "not_started"}
    ],
    "total": 200,
    "passing": 150,
    "failing": 25,
    "not_started": 25
  }
  ```

  ```text
  // 进度说明 (progress.txt)
  第 3 节进度：
  - 修复了身份验证令牌验证
  - 更新了用户模型以处理边缘情况
  - 下一步：调查 user_management 测试失败（测试 #2）
  - 注意：不要删除测试，因为这可能导致功能缺失
  ```
</Accordion>

### 沟通风格

与以前的模型相比，Claude Sonnet 4.5 具有更简洁、更自然的沟通风格：

*   **更直接、更接地气**：提供基于事实的进度报告，而不是自我庆祝式的更新
*   **更具对话性**：稍微更流畅、更口语化，更少机器感
*   **更少冗长**：除非另有提示，否则为了效率可能会跳过详细的摘要

这种沟通风格准确地反映了已完成的工作，没有不必要的阐述。

## 特定情况的指导

### 平衡冗长程度

Claude Sonnet 4.5 倾向于高效，可能会在工具调用后跳过口头摘要，直接跳到下一个操作。虽然这创建了一个简化的工作流，但您可能更希望了解其推理过程。

如果您希望 Claude 在工作时提供更新：

```text 示例提示
完成涉及工具使用的任务后，请简要总结您所做的工作。
```

### 工具使用模式

Claude Sonnet 4.5 经过训练，能够精确遵循指令，并受益于使用特定工具的明确指导。如果您说“你能建议一些更改吗”，它有时会提供建议而不是实施它们——即使进行更改可能是您的意图。

要让 Claude 采取行动，请更明确：

<Accordion title="示例：明确的指示">
  **效果较差（Claude 只会建议）：**

  ```text
  你能建议一些更改来改进这个函数吗？
  ```

  **效果更佳（Claude 将进行更改）：**

  ```text
  更改此函数以提高其性能。
  ```

  或者：

  ```text
  对身份验证流程进行这些编辑。
  ```
</Accordion>

要让 Claude 默认更主动地采取行动，您可以将此添加到您的系统提示中：

```text 主动行动的示例提示
<default_to_action>
默认情况下，实施更改而不是仅仅建议它们。如果用户的意图不明确，请推断出最有可能有用的操作并继续，使用工具发现任何缺失的细节而不是猜测。尝试推断用户关于是否打算进行工具调用（例如，文件编辑或读取）的意图，并相应地采取行动。
</default_to_action>
```

另一方面，如果您希望模型默认更犹豫，更不容易直接进入实现，并且只有在被请求时才采取行动，您可以使用如下提示来引导这种行为：

```text 保守行动的示例提示
<do_not_act_before_instructions>
除非明确指示进行更改，否则不要跳入实现或更改文件。当用户的意图不明确时，默认提供信息、进行研究和提供建议，而不是采取行动。只有在用户明确请求时才进行编辑、修改或实现。
</do_not_act_before_instructions>
```

### 控制响应格式

我们发现有几种方法在控制 Claude 4 模型的输出格式方面特别有效：

1.  **告诉 Claude 该做什么，而不是不该做什么**

    *   而不是：“不要在你的响应中使用 markdown”
    *   尝试：“您的响应应由流畅的散文段落组成。”

2.  **使用 XML 格式指示符**

    *   尝试：“用 <smoothly_flowing_prose_paragraphs> 标签写你的响应的散文部分。”

3.  **使您的提示风格与期望的输出相匹配**

    您提示中使用的格式风格可能会影响 Claude 的响应风格。如果您在输出格式方面仍然遇到可控性问题，我们建议您尽可能地使您的提示风格与您期望的输出风格相匹配。例如，从提示中删除 markdown 可以减少输出中 markdown 的数量。

4.  **对特定的格式偏好使用详细的提示**

    要更好地控制 markdown 和格式的使用，请提供明确的指导：

````text 最小化 markdown 的示例提示
<avoid_excessive_markdown_and_bullet_points>
在撰写报告、文档、技术说明、分析或任何长篇内容时，请使用清晰、流畅的散文，使用完整的段落和句子。使用标准的段落分隔来组织，并主要为 `inline code`、代码块 (```...```) 和简单的标题（### 和 ###）保留 markdown。避免使用 **粗体** 和 *斜体*。

除非以下情况，否则不要使用有序列表 (1. ...) 或无序列表 (*)：a) 您正在呈现真正离散的项目，其中列表格式是最佳选择，或 b) 用户明确请求列表或排名

不要用项目符号或数字列出项目，而是将它们自然地融入句子中。本指南尤其适用于技术写作。使用散文而不是过多的格式会提高用户满意度。切勿输出一系列过于简短的项目符号。

您的目标是可读、流畅的文本，自然地引导读者理解思想，而不是将信息分割成孤立的点。
</avoid_excessive_markdown_and_bullet_points>
````

### 研究与信息收集

Claude Sonnet 4.5 展示了卓越的代理搜索能力，可以有效地从多个来源查找和综合信息。为获得最佳研究结果：

1.  **提供明确的成功标准**：定义什么构成对您的研究问题的成功回答

2.  **鼓励来源验证**：要求 Claude 跨多个来源验证信息

3.  **对于复杂的研究任务，使用结构化方法**：

```text 复杂研究的示例提示
以结构化的方式搜索此信息。在收集数据的同时，提出几个相互竞争的假设。在您的进度说明中跟踪您的置信度水平，以提高校准。定期自我批判您的方法和计划。更新假设树或研究笔记文件，以持久化信息并提供透明度。系统地分解这个复杂的研究任务。
```

这种结构化的方法使 Claude 能够找到并综合几乎任何信息，并迭代地批判其发现，无论语料库的大小如何。

### 子代理编排

Claude Sonnet 4.5 展示了显著改进的原生子代理编排能力。该模型能够识别何时任务将受益于将工作委托给专门的子代理，并主动这样做，而无需明确指示。

要利用此行为：

1.  **确保定义良好的子代理工具**：在工具定义中提供并描述子代理工具
2.  **让 Claude 自然地编排**：Claude 会在没有明确指示的情况下适当地进行委托
3.  **如果需要，调整保守性**：

```text 保守使用子代理的示例提示
只有当任务明确受益于具有新上下文窗口的独立代理时，才委托给子代理。
```

### 模型自我认知

如果您希望 Claude 在您的应用程序中正确识别自己或使用特定的 API 字符串：

```text 模型身份的示例提示
助手是 Claude，由 Anthropic 创建。当前模型是 Claude Sonnet 4.5。
```

对于需要指定模型字符串的 LLM 驱动的应用程序：

```text 模型字符串的示例提示
当需要 LLM 时，请默认使用 Claude Sonnet 4.5，除非用户另有要求。Claude Sonnet 4.5 的确切模型字符串是 claude-sonnet-4-5-20250929。
```

### 利用思考和交错思考能力

Claude 4 提供了思考能力，这对于涉及工具使用后反思或复杂多步推理的任务特别有帮助。您可以引导其初始或交错的思考以获得更好的结果。

```text 示例提示
在收到工具结果后，仔细反思其质量并确定最佳的后续步骤，然后再继续。利用您的思考来根据这些新信息进行计划和迭代，然后采取最佳的下一步行动。
```

<Info>
  有关思考能力的更多信息，请参阅[扩展思考](/en/docs/build-with-claude/extended-thinking)。
</Info>

### 文档创建

Claude Sonnet 4.5 在创建演示文稿、动画和视觉文档方面表现出色。它在该领域达到或超过了 Claude Opus 4.1，具有令人印象深刻的创造性才能和更强的指令遵循能力。在大多数情况下，该模型一次就能产生精美、可用的输出。

为在文档创建中获得最佳结果：

```text 示例提示
创建一个关于[主题]的专业演示文稿。包括周到的设计元素、视觉层次和适当的引人入胜的动画。
```

### 优化并行工具调用

Claude 4 模型在并行工具执行方面表现出色，其中 Sonnet 4.5 在同时触发多个操作方面尤其积极。该模型将：

*   在研究期间运行多个推测性搜索
*   一次读取多个文件以更快地构建上下文
*   并行执行 bash 命令（甚至可能导致系统性能瓶颈）

这种行为很容易引导。虽然该模型在没有提示的情况下并行调用工具的成功率很高，但您可以将其提高到约 100% 或调整积极程度：

```text 最大并行效率的示例提示
<use_parallel_tool_calls>
如果您打算调用多个工具并且工具调用之间没有依赖关系，请并行进行所有独立的工具调用。只要操作可以并行而不是顺序完成，就优先同时调用工具。例如，在读取 3 个文件时，并行运行 3 个工具调用以同时将所有 3 个文件读入上下文。尽可能最大化使用并行工具调用以提高速度和效率。但是，如果某些工具调用依赖于先前的调用来通知依赖值（如参数），则不要并行调用这些工具，而是顺序调用它们。切勿在工具调用中使用占位符或猜测缺失的参数。
</use_parallel_tool_calls>
```

```text 减少并行执行的示例提示
顺序执行操作，并在每个步骤之间稍作暂停以确保稳定性。
```

### 减少代理编码中的文件创建

Claude 4 模型有时可能会为测试和迭代目的创建新文件，尤其是在处理代码时。这种方法允许 Claude 使用文件，特别是 python 脚本，作为“临时草稿纸”，然后再保存其最终输出。使用临时文件可以改善结果，特别是在代理编码用例中。

如果您希望尽量减少净新文件的创建，您可以指示 Claude 在完成后进行清理：

```text 示例提示
如果您为迭代创建了任何临时新文件、脚本或辅助文件，请在任务结束时通过删除这些文件来进行清理。
```

### 增强视觉和前端代码生成

Claude 4 模型可以生成高质量、视觉上独特、功能齐全的用户界面。然而，如果没有指导，前端代码可能会默认使用缺乏视觉趣味的通用模式。要获得出色的 UI 结果：

1.  **明确鼓励创造力：**

```text 示例提示
不要退缩。全力以赴。创建一个令人印象深刻的演示，展示 Web 开发能力。
```

2.  **指定审美方向和设计约束：**

```text 示例提示
使用深蓝色和青色调色板、现代无衬线字体（例如，标题使用 Inter，正文使用系统字体）和带有微妙阴影的卡片式布局，创建一个专业的仪表板。包括周到的细节，如悬停状态、过渡和微交互。应用设计原则：层次、对比、平衡和动感。
```

3.  **鼓励设计多样性和融合美学：**

```text 示例提示
提供多种设计选项。通过组合来自不同来源的元素来创造融合美学——一种配色方案、不同的排版、另一种布局原则。避免通用的居中布局、简单的渐变和统一的样式。
```

4.  **明确要求特定功能：**

*   “包括尽可能多的相关功能和交互”
*   “添加动画和交互元素”
*   “创建一个超越基础的功能齐全的实现”

### 避免专注于通过测试和硬编码

Claude 4 模型有时可能过于专注于使测试通过，而牺牲了更通用的解决方案，或者可能使用辅助脚本等变通方法进行复杂的重构，而不是直接使用标准工具。为防止这种行为并确保稳健、可推广的解决方案：

```text 示例提示
请使用可用的标准工具编写一个高质量、通用的解决方案。不要创建辅助脚本或变通方法来更有效地完成任务。实现一个对所有有效输入都正常工作的解决方案，而不仅仅是测试用例。不要硬编码值或创建仅适用于特定测试输入的解决方案。相反，实现解决问题的一般逻辑。

专注于理解问题需求并实现正确的算法。测试是为了验证正确性，而不是定义解决方案。提供遵循最佳实践和软件设计原则的原则性实现。

如果任务不合理或不可行，或者任何测试不正确，请通知我，而不是绕过它们。解决方案应该是稳健、可维护和可扩展的。
```

### 最小化代理编码中的幻觉

Claude 4 模型不太容易产生幻觉，并根据代码给出更准确、有根据、智能的答案。为进一步鼓励这种行为并最小化幻觉：

```text 示例提示
<investigate_before_answering>
切勿对您未打开的代码进行推测。如果用户引用特定文件，您必须在回答之前阅读该文件。在回答有关代码库的问题之前，请务行调查并阅读相关文件。除非您确定正确答案，否则在调查之前切勿对代码做出任何声明 - 给出有根据且无幻觉的答案。
</investigate_before_answering>
```

## 迁移注意事项

从 Sonnet 3.7 迁移到 Claude 4（包括 Sonnet 4.5）时：

1.  **具体说明期望的行为**：考虑准确描述您希望在输出中看到的内容。

2.  **用修饰语构建您的指令**：添加鼓励 Claude 提高其输出质量和细节的修饰语，有助于更好地塑造 Claude 的性能。例如，不要用“创建一个分析仪表板”，而要用“创建一个分析仪表板。包括尽可能多的相关功能和交互。超越基础，创建一个功能齐全的实现。”

3.  **明确要求特定功能**：如果需要动画和交互元素，应明确要求。

